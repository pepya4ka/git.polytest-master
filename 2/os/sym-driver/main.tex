\input{settings.tex}
\begin{document}
\input{title.tex}
\input{ToC.tex}

\section{Цель работы}
Анализ структуры драйвера, его места в операционной системе. Написание простейшего драйвера для символьного устройства, встраивание его в операционную систему и анализ его функционирования.

\section{План работы}
\begin{enumerate}
\item Получение объектного файла драйвера - *.ko;
\item Загрузка объектного модуля *.ko в ядро;
\item Создание символьного устройства;
\item Изменение доступа к файлу символьного устройства;
\item Запись в файл устройства;
\item Чтение файла устройства;
\item Выгрузка модуля из ядра ОС;
\item Удаление файла символьного устройства;
\item Приведение каталога, в котором производилась сборка драйвера к исходному виду.
\end{enumerate}

\section{Сведения о системе}
\lstinputlisting{listings/info.txt}

\clearpage

\section{Выполнение работы}

\subsection{Анализ}
\textbf{Драйвер устройства} – это программное обеспечение, с помощью которого осуществляется управление устройством. Драйвер учитывает как специфические особенности аппаратуры, которую он контролирует, так и особенности операционной системы, в которой он функционирует. 

Можно сказать, что драйвер состоит из двух частей:
\begin{enumerate}
\item является специфической для конкретного устройства;
\item является специфической для ОС.
\end{enumerate}
Часть драйвера устройства, характерная для конкретного устройства, будет одной и той же во всех операционных системах и в большей мере она связана с анализом и пониманием спецификаций устройства, а не с программированием. 

Также, в зависимости от контролируемого устройства, драйверы бывают нескольких типов:
\begin{itemize}
\item \textbf{Символьные драйверы} – программное обеспечение, которое управляет доступом к символьному устройству (клавиатура, мышь и т.п), которое генерирует или воспринимает поток символов (байты);
\item \textbf{Блочные драйверы} – программное обеспечение, которое управляет доступом к блочному устройству (жесткий диск), которые оперируют блоками данных;
\end{itemize}

\par Драйвер - это объектный файл, загруженный в ядро, который предоставляет набор функций для доступа к устройству из ОС. 

\subsection{Реализация драйвера}

\subsubsection{Компиляция}
\par Исходный код драйвера символьного устройства приведен в приложении к отчету. Структура драйвера является базовой, и может быть использована для создания драйверов для более сложных устройств.

\lstinputlisting[caption=Лог сборки объектного файла драйвера]{listings/log1.txt}

\par По итогу компиляции, появляется файл с раширением \textbf{.ko}. Дополнительно, с помощью команды \textbf{modinfo} можно получить информуцию о модуле.

\lstinputlisting[caption=Информация о модуле]{listings/log2.txt}

\subsubsection{Встраивание в ядро}

\par Для загрузки модуля в ядро, используется команда \textbf{insmod} с правами суперпользователя. 

\lstinputlisting[caption=Встраивание модуля]{listings/log3.txt}

\par Дополнительно была выведена часть системного лога \textbf{/var/log/syslog}. Из лога видно, что были присвоены старший(246) и младший(0) номера драйвера, которые необходимы для связывания файла символьного устройства с встроенным драйвером.

\lstinputlisting[caption=Cистемный лог]{listings/log4.txt}

\par Дополнительно, с помощью команды \textbf{lsmod}, можно проверить загрузку модуля.

\lstinputlisting[caption=Проверка загрузки модуля]{listings/log5.txt}

\subsubsection{Создание символьного устройства}

\par Создать файл символьного устройства можно с помощью команды \textbf{mknod}, указав в ней старший и младший номера драйвера. 

\lstinputlisting[caption=Создание символьного устройства]{listings/log61.txt}


\subsubsection{Изменение прав доступа}
Изменение прав доступа необходимо для обеспечения возможности записи и чтения файла символьного устройства. Для этого необходимо использовать команду \textbf{chmod}.

\lstinputlisting[caption=Изменение прав доступа]{listings/log62.txt}

\subsubsection{Запись в файл и чтение из файла устройства}

\par Запись в файл символьного устройства осуществлялась с помощью команды \textbf{echo} и перенаправления потока ввода в файл символьного устройства. Чтение выполнялось с помощью команды \textbf{cat}. 

\lstinputlisting[caption=Записиь и чтение в файл символьного устройства]{listings/log7.txt}

\clearpage

Откроем содержимое системного лога \textbf{/var/log/syslog}.

\lstinputlisting[caption=Часть системного лога]{listings/log8.txt}

Из данного лога, становиться понятным, что при записи совершается: \textbf{открытие, запись, закрытие} файла, а при чтении: \textbf{открытие, чтение, закрытие} файла.

\subsubsection{Запись в файл и чтение из файла устройства (пользовательская программа)}

\par Также работа с символьным устройством была произведена с помощью пользовательской программы(прикреплена в приложении), суть которой заключается в выполнении команд \textbf{open, read, write, close}.

\lstinputlisting[caption=Лог пользовательской программы]{listings/log9.txt}

\par Откроем содержимое системного лога \textbf{/var/log/syslog}.

\lstinputlisting[caption=Часть системного лога]{listings/log10.txt}

\par Модуль сработал корректно, как и ожидалось, команды \textbf{open, read, write, close} были выполнены именно в этом порядке.

\subsubsection{Выгрузка модуля}

\par Для выгрузки модуля из ядра системы используется команда \textbf{rmmod} с правами суперпользователя.

\lstinputlisting[caption=Выгрузка модуля]{listings/log11.txt}

\par В логе \textbf{/var/log/syslog} также появилась соответствующая запись.


\subsubsection{Удаление файла символьного устройства}
Для удаления файла символьного устройства используется команда \textbf{rm}.

\lstinputlisting[caption=Удаление файла символьного устройства]{listings/log12.txt}


\subsubsection{Приведение каталога сборки к исходному виду}

\par Для очистки каталога от исполняемых файлов используется сценарий \textbf{clean} из \textbf{Makefile}.

\lstinputlisting[caption=Удаление файла символьного устройства]{listings/log13.txt}

\section{Вывод}
В итоге данной лабораторной работы было выполнено:
\begin{itemize}
    \item Изучение базовой структуры драйвера для ОС Linux
    \item Анализ функционирования драйвера символьного устройства на примере простейшего драйвера
    \item Получение базовых знаний и навыков встраивания/выгрузки модулей в ядро операционной системы
\end{itemize}

\clearpage

\section{Приложение 1}
\textbf{Исходный код драйвера символьного устройства chardev.c}
\lstinputlisting[caption=Удаление файла символьного устройства]{listings/chardev.c}


\section{Приложение 2}
\textbf{Makefile}
\lstinputlisting{listings/Makefile}

\section{Приложение 3}
\textbf{Пользовательская программа для работы с символьным устройством}
\lstinputlisting{listings/userdev.c}


\end{document}
